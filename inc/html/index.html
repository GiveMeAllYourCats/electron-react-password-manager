<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Password App</title>
    <link rel="stylesheet" href="../css/bootstrap.css">
    <link rel="stylesheet" href="../css/bootstrap-theme.css">
  </head>
  <body>
    <div class="container">
      <h2>Password App</h2>
      <p>Here you can manage your passwords</p>
      <button type="button" class="btn btn-primary btn" data-toggle="modal" data-target="#myModal">
        Add password
      </button>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Service</th>
            <th>User/Email</th>
            <th>Password</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
        </tbody> 
      </table>
    </div>
  </body>
  
  <script>
    window.$ = window.jQuery = require('../js/jquery.js');
    const {ipcRenderer} = require('electron');
    const notifier = require('node-notifier');
    const path = require('path');
    require('../js/bootstrap.js');
    require('../js/pubsub.js');
  </script>
    
  <script> 
    let post;
    let i;
    const Clipboard = require('clipboard');
    ipcRenderer.send('populateTable');
    
    ipcRenderer.on('passtable', (event, results) => {
      var $table = $('table'); 
      var table = $("table tbody");
      i = 0;
      $.each(results,(idx, elem) => {
          i++;
          table.append("<tr id='trid_"+elem.id+"'>");
          var tr = $("#trid_"+elem.id);
          tr.append("<td>"+elem.service+"</td>");
          tr.append("<td><input style='width:80%;display:inline' type='text' readonly id='inputemail_"+i+"' value='"+elem.email+"' class='form-control'> <button class='copyBtn' data-clipboard-target='#inputemail_"+i+"'><img src='../img/copy.png'></button</td>");
          tr.append("<td><input style='width:80%;display:inline' type='text' readonly id='inputpass_"+i+"' rawpass="+elem.password+" value="+elem.password.replace(/./g, '*')+" class='form-control'></span> <button class='copyBtn' idcol='"+i+"' data-clipboard-target='#inputpass_"+i+"'><img src='../img/copy.png'></button></td>");
          tr.append("<td><button class='delBtn' dataid='"+elem.id+"'><img src='../img/delete.png'></button></td>");
          tr.append("</tr>");
      });
      
      $('.copyBtn').mouseover(function() {
        let inputpass = $('#inputpass_'+$(this).attr('idcol'));
        inputpass.val(inputpass.attr('rawpass'))
      });
       
      $('.copyBtn').mouseout(function() {
        let inputpass = $('#inputpass_'+$(this).attr('idcol'));
        if(inputpass.attr('rawpass')) inputpass.val(inputpass.attr('rawpass').replace(/./g, '*'))
      });
      
      $('.delBtn').click(function(){
        $('#trid_'+$(this).attr('dataid')).remove();
        ipcRenderer.send('deleteService', $(this).attr('dataid'));
      })
    });
     
    $(() => {
      $('.add').click(() => {
        addService();
      })
      
      $('.modal').on('shown.bs.modal', () => {
        $('#inputService').focus();
      })
      
      $('#inputService').keypress(e => {
        if (e.which == 13) $('#inputEmail').focus();
      });
      
      $('#inputEmail').keypress(e => {
        if (e.which == 13) $('#inputPassword').focus();
      });
      
      $('#inputPassword').keypress(e => {
        if (e.which == 13) addService();
      });
      
      new Clipboard('.copyBtn');
    });
    
    const addService = () => {
      $('#inputService').attr('disabled','disabled');
      $('#inputPassword').attr('disabled','disabled');
      $('#inputEmail').attr('disabled','disabled');
      $('.add').attr('disabled','disabled');
      $('.cancel').attr('disabled','disabled');
      
      post = {
        service: $('#inputService').val(),
        password: $('#inputPassword').val(),
        email: $('#inputEmail').val(),
      }
      ipcRenderer.send('addService', post);
    }
    
    let clicked = false;
    
    const replied = data => {
      if(!post) return;
      if(clicked){
        clicked = false;
        return;
      }
      
      if(data.humane.extra) post.id = data.humane.extra.id;
      i++;
      $('#inputService').removeAttr('disabled','disabled').val("");
      $('#inputPassword').removeAttr('disabled','disabled').val("");
      $('#inputEmail').removeAttr('disabled','disabled').val("");
      $('.add').removeAttr('disabled','disabled');
      $('.cancel').removeAttr('disabled','disabled');
      $("#myModal").modal("hide");
      var $table = $('table');
      var table = $("table tbody");
      table.append("<tr id='trid_"+post.id+"'>");
      var tr = $("#trid_"+post.id);
      tr.append("<td>"+post.service+"</td>");
      tr.append("<td><input style='width:80%;display:inline' type='text' readonly id='inputemail_"+i+"' value='"+post.email+"' class='form-control'> <button id='copyemailbtn_"+i+"'  data-clipboard-target='#inputemail_"+i+"'><img src='../img/copy.png'></button></td>");
      tr.append("<td><input style='width:80%;display:inline' type='text' readonly id='inputpass_"+i+"' rawpass='"+post.password+"' value='"+post.password.replace(/./g, '*')+"' class='form-control'></span> <button id='copypassbtn_"+i+"' idcol='"+i+"' data-clipboard-target='#inputpass_"+i+"'><img src='../img/copy.png'></button></td>");
      tr.append("<td><button id='deletebtn_"+i+"' dataid='"+post.id+"'><img src='../img/delete.png'></button></td>");
      tr.append("</tr>"); 
      
      $('#copypassbtn_'+i).mouseover(function() { 
        let inputpass = $('#inputpass_'+$(this).attr('idcol'));
        inputpass.val(inputpass.attr('rawpass'))
      });
       
      $('#copypassbtn_'+i).mouseout(function() {
        let inputpass = $('#inputpass_'+$(this).attr('idcol'));
        if(inputpass.attr('rawpass')) inputpass.val(inputpass.attr('rawpass').replace(/./g, '*'))
      });
        
      $('#deletebtn_'+i).click(function(){
        clicked = true;
        $('#trid_'+$(this).attr('dataid')).remove();
        ipcRenderer.send('deleteService', $(this).attr('dataid'));
      })
      
      new Clipboard('#copypassbtn_'+i);
      new Clipboard('#copyemailbtn_'+i);
    }
    
  </script>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Add a Password</h4>
      </div> 
      <div class="modal-body">
          <div class="form-signin">
            <label for="inputService" class="sr-only">Service</label>
            <input type="input" id="inputService" class="form-control" placeholder="Service e.g Steam" required>
            <label for="inputEmail" class="sr-only">Username</label>
            <input type="input" id="inputEmail" class="form-control" placeholder="Email/Username" required>
            <label for="inputPassword" class="sr-only">Password</label>
            <input type="password" id="inputPassword" class="form-control" placeholder="Password" required>
          </div> 
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default cancel" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary add">Add</button>
      </div>
    </div>
  </div>
</div>
</html>
 